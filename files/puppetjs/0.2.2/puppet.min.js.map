{"version":3,"file":"puppet.min.js","sources":["src/puppet.js"],"names":["global","Puppet","remoteUrl","callback","obj","undefined","window","Promise","Error","this","debug","observer","referer","useWebSocket","localPatchQueue","handleResponseCookie","ignoreCache","ignoreAdd","cancelled","lastRequestPromise","xhr","bootstrap","bind","history_pushState","history","pushState","that","data","title","url","call","changeState","markObjPropertyByPath","path","keys","split","len","length","i","recursiveMarkObjProperties","placeMarkers","parent","key","subject","PuppetJsClickTrigger$","hasOwnProperty","Object","defineProperty","enumerable","get","recursiveExtend","par","lastClickHandler","lastPopstateHandler","lastBlurHandler","lastPuppet","prototype","res","tmp","JSON","parse","responseText","observe","document","body","removeEventListener","addEventListener","clickHandler","historyHandler","sendLocalChange","fixShadowRootClicks","webSocketUpgrade","host","location","wsPath","replace","upgradeURL","resolve","reject","_ws","WebSocket","onopen","event","onmessage","patches","handleRemoteChange","webSocketSendResolve","onerror","showError","onclose","code","reason","handleResponseHeader","getResponseHeader","setReferer","cookie","read","erase","jsonpatch","queueLocalChange","unobserve","Array","push","apply","activeElement","nodeName","getAttribute","flattenPatches","handleLocalChange","ev","target","generate","isIgnored","op","test","arr","joined","ilen","seen","splice","txt","stringify","indexOf","then","webSocketSend","forEach","patch","value","desc","substring","showWarning","onRemoteChange","href","detail","impl","parentA","closestHrefParent","isApplicationLink","preventDefault","stopPropagation","morphUrl","type","heading","description","console","warn","DIV","getElementById","createElement","id","style","border","background","padding","position","top","left","zIndex","appendChild","H1","innerHTML","PRE","whiteSpace","accept","beforeSend","error","req","XMLHttpRequest","onload","status","statusText","open","setRequestHeader","send","findShadowRoots","el","out","childNodes","nodeType","shadowRoot","polymerShadowRoot_","shadowRoots","documentElement","old","Element","createShadowRoot","arguments","elem","parser","protocol","create","name","days","expires","date","Date","setTime","getTime","toGMTString","readAll","cookies","result","l","item","decodeURIComponent","parentNode"],"mappings":"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","sourcesContent":["/*! puppet.js 0.2.2\n * (c) 2013 Joachim Wester\n * MIT license\n */\n\n(function (global) {\n  var lastClickHandler\n    , lastPopstateHandler\n    , lastBlurHandler\n    , lastPuppet;\n\n  /**\n   * Defines a connection to a remote PATCH server, returns callback to a object that is persistent between browser and server\n   * @param remoteUrl If undefined, current window.location.href will be used as the PATCH server URL\n   * @param callback Called after initial state object is received from the server\n   * @param obj Optional object where the parsed JSON data will be inserted\n   */\n  function Puppet(remoteUrl, callback, obj) {\n    if (window.Promise === undefined) {\n      throw new Error(\"Promise API not available. If you are using an outdated browser, make sure to load a Promise/A+ shim, e.g. https://github.com/jakearchibald/es6-promise\");\n    }\n\n    this.debug = true;\n    this.remoteUrl = remoteUrl;\n    this.callback = callback;\n    this.obj = obj || {};\n    this.observer = null;\n    this.referer = null;\n    this.useWebSocket = false; //change to TRUE to enable WebSocket connection\n    this.localPatchQueue = [];\n    this.handleResponseCookie();\n\n    this.ignoreCache = [];\n    this.ignoreAdd = null; //undefined, null or regexp (tested against JSON Pointer in JSON Patch)\n\n    //usage:\n    //puppet.ignoreAdd = null;  //undefined or null means that all properties added on client will be sent to server\n    //puppet.ignoreAdd = /./; //ignore all the \"add\" operations\n    //puppet.ignoreAdd = /\\/\\$.+/; //ignore the \"add\" operations of properties that start with $\n    //puppet.ignoreAdd = /\\/_.+/; //ignore the \"add\" operations of properties that start with _\n\n    this.cancelled = false;\n    this.lastRequestPromise = this.xhr(this.remoteUrl, 'application/json', null, this.bootstrap.bind(this));\n\n    /**\n     * There is on \"onpushstate\" event, so PuppetJS needs to wrap history.pushState to know when it is called\n     * @type {Function}\n     * @private\n     */\n    var history_pushState = window.history.pushState;\n    var that = this;\n    window.history.pushState = function (data, title, url) {\n      history_pushState.call(window.history, data, title, url);\n      that.changeState(url);\n    };\n  }\n\n  /**\n   * PuppetJsClickTrigger$ contains Unicode symbols for \"NULL\" text rendered stylized using Unicode\n   * character \"SYMBOL FOR NULL\" (2400)\n   *\n   * With PuppetJs, any property having `null` value will be rendered as stylized \"NULL\" text\n   * to emphasize that it probably should be set as empty string instead.\n   *\n   * The benefit of having this string is that any local change to `null` value (also\n   * from `null` to `null`) can be detected and sent as `null` to the server.\n   */\n  var PuppetJsClickTrigger$ = \"\\u2400\";\n\n  function markObjPropertyByPath(obj, path) {\n    var keys = path.split('/');\n    var len = keys.length;\n    if (keys.length > 2) {\n      for (var i = 1; i < len - 1; i++) {\n        obj = obj[keys[i]];\n      }\n    }\n    recursiveMarkObjProperties(obj, keys[len - 1]);\n  }\n\n  function placeMarkers(parent, key) {\n    var subject = parent[key];\n    if (subject === null) {\n      parent[key] = PuppetJsClickTrigger$;\n    }\n    else if (typeof subject === 'object' && !subject.hasOwnProperty('$parent')) {\n      Object.defineProperty(subject, '$parent', {\n        enumerable: false,\n        get: function () {\n          return parent;\n        }\n      });\n    }\n  }\n\n  function recursiveMarkObjProperties(parent, key) {\n    placeMarkers(parent, key);\n    parent = parent[key];\n    for (var i in parent) {\n      if (parent.hasOwnProperty(i) && typeof parent[i] === 'object') {\n        recursiveMarkObjProperties(parent, i);\n      }\n    }\n  }\n\n  function recursiveExtend(par, obj) {\n    for (var i in obj) {\n      if (obj.hasOwnProperty(i)) {\n        if (typeof obj[i] === 'object' && par.hasOwnProperty(i)) {\n          recursiveExtend(par[i], obj[i]);\n        }\n        else {\n          par[i] = obj[i];\n        }\n      }\n    }\n  }\n  /**\n   * [bootstrap description]\n   * @param  {[type]} res [description]\n   * @return {Promise || true}     Promise for #webSocketUpgrade or just `true` is websockets disabled.\n   */\n  Puppet.prototype.bootstrap = function (res) {\n    var tmp = JSON.parse(res.responseText);\n    recursiveExtend(this.obj, tmp);\n\n    recursiveMarkObjProperties(this, \"obj\");\n    this.observe();\n    if (this.callback) {\n      this.callback(this.obj);\n    }\n    if (lastClickHandler) {\n      document.body.removeEventListener('click', lastClickHandler);\n      window.removeEventListener('popstate', lastPopstateHandler);\n      document.body.removeEventListener('blur', lastBlurHandler, true);\n    }\n    document.body.addEventListener('click', lastClickHandler = this.clickHandler.bind(this));\n    window.addEventListener('popstate', lastPopstateHandler = this.historyHandler.bind(this)); //better here than in constructor, because Chrome triggers popstate on page load\n    document.body.addEventListener('blur', lastBlurHandler = this.sendLocalChange.bind(this), true);\n\n    if (!lastPuppet) {\n      lastPuppet = this;\n      this.fixShadowRootClicks();\n    }\n\n    return this.useWebSocket ? this.webSocketUpgrade() : true ;\n  };\n\n  /**\n   * Send a WebSocket upgrade request to the server.\n   * For testing purposes WS upgrade url is hardcoded now in PuppetJS (replace __default/ID with __default/wsupgrade/ID)\n   * In future, server should suggest the WebSocket upgrade URL\n   * @returns {Promise} that WS get opened, resolves/rejects with WS event [description]\n   */\n  Puppet.prototype.webSocketUpgrade = function () {\n    var that = this;\n    var host = window.location.host;\n    var wsPath = this.referer.replace(/__([^\\/]*)\\//g, \"__$1/wsupgrade/\");\n    var upgradeURL = \"ws://\" + host + wsPath;\n    return new Promise(function (resolve, reject) {\n      that._ws = new WebSocket(upgradeURL);\n      that._ws.onopen = function (event) {\n        resolve( event );\n      };\n      that._ws.onmessage = function (event) {\n        var patches = JSON.parse(event.data);\n        that.handleRemoteChange(patches);\n        that.webSocketSendResolve( event );\n      };\n      that._ws.onerror = function (event) {\n        that.showError(\"WebSocket connection could not be made\", (event.data || \"\") + \"\\nCould not connect to: \" + upgradeURL);\n        reject( event );\n      };\n      that._ws.onclose = function (event) {\n        that.showError(\"WebSocket connection closed\", event.code + \" \" + event.reason);\n      };\n    });\n  };\n\n  Puppet.prototype.handleResponseHeader = function (xhr) {\n    var location = xhr.getResponseHeader('X-Location') || xhr.getResponseHeader('Location');\n    if (location) {\n      this.setReferer(location);\n    }\n  };\n\n  /**\n   * PuppetJs does not use cookies because of sessions (you need to take care of it in your application code)\n   * Reason PuppetJs handles cookies is different:\n   * JavaScript cannot read HTTP \"Location\" header for the main HTML document, but it can read cookies\n   * So if you want to establish session in the main HTML document, send \"Location\" value as a cookie\n   * The cookie will be erased (replaced with empty value) after reading\n   */\n  Puppet.prototype.handleResponseCookie = function () {\n    var location = cookie.read('Location');\n    if (location) { //if cookie exists and is not empty\n      this.setReferer(location);\n      cookie.erase('Location');\n    }\n  };\n\n  Puppet.prototype.setReferer = function (referer) {\n    if (this.referer && this.referer !== referer) {\n      this.showError(\"Error: Session lost\", \"Server replied with a different session ID that was already set. \\nPossibly a server restart happened while you were working. \\nPlease reload the page.\\n\\nPrevious session ID: \" + this.referer + \"\\nNew session ID: \" + referer);\n    }\n    this.referer = referer;\n  };\n\n  Puppet.prototype.observe = function () {\n    this.cancelled = false;\n    this.observer = jsonpatch.observe(this.obj, this.queueLocalChange.bind(this));\n  };\n\n  Puppet.prototype.unobserve = function () {\n    this.cancelled = true;\n    if (this.observer) { //there is a bug in JSON-Patch when trying to unobserve something that is already unobserved\n      jsonpatch.unobserve(this.obj, this.observer);\n      this.observer = null;\n    }\n  };\n\n  Puppet.prototype.queueLocalChange = function (patches) {\n    Array.prototype.push.apply(this.localPatchQueue, patches);\n    if ((document.activeElement.nodeName !== 'INPUT' && document.activeElement.nodeName !== 'TEXTAREA') || document.activeElement.getAttribute('update-on') === 'input') {\n      this.flattenPatches(this.localPatchQueue);\n      if (this.localPatchQueue.length) {\n        this.handleLocalChange(this.localPatchQueue);\n        this.localPatchQueue.length = 0;\n      }\n    }\n  };\n\n  Puppet.prototype.sendLocalChange = function (ev) {\n    if (ev && (ev.target === document.body || ev.target.nodeName === \"BODY\")) { //Polymer warps ev.target so it is not exactly document.body\n      return; //IE triggers blur event on document.body. This is not what we need\n    }\n    jsonpatch.generate(this.observer);\n    this.flattenPatches(this.localPatchQueue);\n    if (this.localPatchQueue.length) {\n      this.handleLocalChange(this.localPatchQueue);\n      this.localPatchQueue.length = 0;\n    }\n  };\n\n  Puppet.prototype.isIgnored = function (path, op) {\n    if (this.ignoreAdd) {\n      if (op === 'add' && this.ignoreAdd.test(path)) {\n        this.ignoreCache[path] = true;\n        return true;\n      }\n      var arr = path.split('/');\n      var joined = '';\n      for (var i = 1, ilen = arr.length; i < ilen; i++) {\n        joined += '/' + arr[i];\n        if (this.ignoreCache[joined]) {\n          return true; //once we decided to ignore something that was added, other operations (replace, remove, ...) are ignored as well\n        }\n      }\n    }\n    return false;\n  };\n\n  //merges redundant patches and ignores private member changes\n  Puppet.prototype.flattenPatches = function (patches) {\n    var seen = {};\n    for (var i = 0, ilen = patches.length; i < ilen; i++) {\n      if (this.isIgnored(patches[i].path, patches[i].op)) { //if it is ignored, remove patch\n        patches.splice(i, 1); //ignore changes to properties that start with PRIVATE_PREFIX\n        ilen--;\n        i--;\n      }\n      else if (patches[i].op === 'replace') { //if it is already seen in the patches array, replace the previous instance\n        if (seen[patches[i].path] !== undefined) {\n          patches[seen[patches[i].path]] = patches[i];\n          patches.splice(i, 1);\n          ilen--;\n          i--;\n        }\n        else {\n          seen[patches[i].path] = i;\n        }\n      }\n    }\n  };\n\n  Puppet.prototype.handleLocalChange = function (patches) {\n    var that = this;\n    var txt = JSON.stringify(patches);\n    if (txt.indexOf('__Jasmine_been_here_before__') > -1) {\n      throw new Error(\"PuppetJs did not handle Jasmine test case correctly\");\n    }\n    if (this.useWebSocket) {\n      this.lastRequestPromise = this.lastRequestPromise.then( this.webSocketSend.bind(this,txt) );\n    }\n    else {\n      //\"referer\" should be used as the url when sending JSON Patches (see https://github.com/PuppetJs/PuppetJs/wiki/Server-communication)\n      this.lastRequestPromise = this.lastRequestPromise.then(function () {\n        return that.xhr(that.referer || that.remoteUrl, 'application/json-patch+json', txt, function (res) {\n          var patches = JSON.parse(res.responseText || '[]'); //fault tolerance - empty response string should be treated as empty patch array\n          that.handleRemoteChange(patches);\n        })\n      });\n    }\n    this.unobserve();\n    patches.forEach(function (patch) {\n      if ((patch.op === \"add\" || patch.op === \"replace\" || patch.op === \"test\") && patch.value === null) {\n        patch.value = PuppetJsClickTrigger$;\n        jsonpatch.apply(that.obj, [patch]);\n      }\n      markObjPropertyByPath(that.obj, patch.path);\n    });\n    this.observe();\n  };\n\n  Puppet.prototype.handleRemoteChange = function (patches) {\n    if (!this.observer) {\n      return; //ignore remote change if we are not watching anymore\n    }\n    if (patches.length === void 0) {\n      throw new Error(\"Patches should be an array\");\n    }\n    this.unobserve();\n    jsonpatch.apply(this.obj, patches);\n    var that = this;\n    patches.forEach(function (patch) {\n      if (patch.path === \"/\") {\n        var desc = JSON.stringify(patches);\n        if (desc.length > 103) {\n          desc = desc.substring(0, 100) + \"...\";\n        }\n        that.showWarning(\"Server pushed patch that replaces the object root\", desc);\n      }\n      if (patch.op === \"add\" || patch.op === \"replace\" || patch.op === \"test\") {\n        markObjPropertyByPath(that.obj, patch.path);\n      }\n    });\n    this.observe();\n    if (this.onRemoteChange) {\n      this.onRemoteChange(patches);\n    }\n  };\n\n  Puppet.prototype.changeState = function (href) {\n    var that = this;\n    this.lastRequestPromise = this.lastRequestPromise.then(function () {\n      return that.xhr(href, 'application/json-patch+json', null, function (res) {\n        var patches = JSON.parse(res.responseText || '[]'); //fault tolerance - empty response string should be treated as empty patch array\n        that.handleRemoteChange(patches);\n      })\n    });\n  };\n\n  Puppet.prototype.clickHandler = function (event) {\n    if (event.detail && event.detail.target) {\n      //detail is Polymer\n      event = event.detail;\n    }\n    var target = event.target;\n    if (target.impl) {\n      //impl is Polymer\n      target = target.impl;\n    }\n\n    if (target.nodeName !== 'A') {\n      var parentA = closestHrefParent(target, 'A');\n      if (parentA) {\n        target = parentA;\n      }\n    }\n\n    //needed since Polymer 0.2.0 in Chrome stable / Web Plaftorm features disabled\n    //because target.href returns undefined for <polymer-ui-menu-item href=\"...\"> (which is an error)\n    //while target.getAttribute(\"href\") returns desired href (as string)\n    var href = target.href || target.getAttribute(\"href\");\n\n    if (href && Puppet.isApplicationLink(href)) {\n      event.preventDefault();\n      event.stopPropagation();\n      this.morphUrl(href);\n    }\n    else if (target.type === 'submit') {\n      event.preventDefault();\n    }\n    else {\n      this.sendLocalChange(); //needed for checkbox\n    }\n  };\n\n  Puppet.prototype.historyHandler = function (/*event*/) {\n    this.changeState(location.href);\n  };\n\n  Puppet.prototype.showWarning = function (heading, description) {\n    if (this.debug && global.console && console.warn) {\n      if (description) {\n        heading += \" (\" + description + \")\";\n      }\n      console.warn(\"PuppetJs warning: \" + heading);\n    }\n  };\n\n  Puppet.prototype.showError = function (heading, description) {\n    if (this.debug) {\n      var DIV = document.getElementById('puppetjs-error');\n      if (!DIV) {\n        DIV = document.createElement('DIV');\n        DIV.id = 'puppetjs-error';\n        DIV.style.border = '1px solid #dFb5b4';\n        DIV.style.background = '#fcf2f2';\n        DIV.style.padding = '10px 16px';\n        DIV.style.position = 'absolute';\n        DIV.style.top = '0';\n        DIV.style.left = '0';\n        DIV.style.zIndex = '999';\n        document.body.appendChild(DIV);\n      }\n\n      var H1 = document.createElement('H1');\n      H1.innerHTML = heading;\n\n      var PRE = document.createElement('PRE');\n      PRE.innerHTML = description;\n      PRE.style.whiteSpace = 'pre-wrap';\n\n      DIV.appendChild(H1);\n      DIV.appendChild(PRE);\n    }\n    throw new Error(description);\n  };\n\n  /**\n   * Internal method to perform XMLHttpRequest\n   * @param url (Optional) URL to send the request. If empty string, undefined or null given - the request will be sent to window location\n   * @param accept (Optional) HTTP accept header\n   * @param data (Optional) Data payload\n   * @param callback (Optional) function\n   * @param beforeSend (Optional) Function that modifies the XHR object before the request is sent. Added for hackability\n   * @returns {Promise} Promise that XHR will be sent. Resolves with response, or callback's result for response (if callback given)\n   */\n  Puppet.prototype.xhr = function (url, accept, data, callback, beforeSend) {\n    //this.handleResponseCookie();\n    cookie.erase('Location'); //more invasive cookie erasing because sometimes the cookie was still visible in the requests\n    var that = this;\n    return new Promise(function (resolve, reject) {\n      if (that.cancelled) {\n        console.error(\"PuppetJs: Promise cancelled on request\");\n        reject();\n        return;\n      }\n      var req = new XMLHttpRequest();\n      req.onload = function () {\n        var res = this;\n        that.handleResponseCookie();\n        that.handleResponseHeader(res);\n        if (res.status >= 400 && res.status <= 599) {\n          that.showError('PuppetJs JSON response error', 'Server responded with error ' + res.status + ' ' + res.statusText + '\\n\\n' + res.responseText);\n          reject();\n        }\n        else {\n          resolve( callback && callback.call(that, res) || res);\n        }\n      };\n      url = url || window.location.href;\n      if (data) {\n        req.open(\"PATCH\", url, true);\n        req.setRequestHeader('Content-Type', 'application/json-patch+json');\n      }\n      else {\n        req.open(\"GET\", url, true);\n      }\n      if (accept) {\n        req.setRequestHeader('Accept', accept);\n      }\n      if (that.referer) {\n        req.setRequestHeader('X-Referer', that.referer);\n      }\n      if (beforeSend) {\n        beforeSend.call(that, req);\n      }\n      req.send(data);\n    });\n  };\n\n  /**\n   * Internal method to perform WebSocket request that returns a promise which is resolved when the response comes\n   * @param data Data payload\n   * @returns {Promise} that data will be sent to WS, resolves with WS event\n   * @see #webSocketUpgrade\n   */\n  Puppet.prototype.webSocketSend = function (data) {\n    var that = this;\n    return new Promise(function (resolve, reject) {\n      that.webSocketSendResolve = resolve;\n      that._ws.send(data);\n    });\n  };\n\n  /**\n   * Push a new URL to the browser address bar and send a patch request (empty or including queued local patches)\n   * so that the URL handlers can be executed on the server\n   * @param url\n   */\n  Puppet.prototype.morphUrl = function (url) {\n    history.pushState(null, null, url);\n  };\n\n  /**\n   * Returns array of shadow roots inside of a element (recursive)\n   * @param el\n   * @param out (Optional)\n   */\n  Puppet.prototype.findShadowRoots = function (el, out) {\n    if (!out) {\n      out = [];\n    }\n    for (var i = 0, ilen = el.childNodes.length; i < ilen; i++) {\n      if (el.childNodes[i].nodeType === 1) {\n        var shadowRoot = el.childNodes[i].shadowRoot || el.childNodes[i].polymerShadowRoot_;\n        if (shadowRoot) {\n          out.push(shadowRoot);\n          this.findShadowRoots(shadowRoot, out);\n        }\n        this.findShadowRoots(el.childNodes[i], out);\n      }\n    }\n    return out;\n  };\n\n  /**\n   * Catches clicks in Shadow DOM\n   * @see <a href=\"https://groups.google.com/forum/#!topic/polymer-dev/fDRlCT7nNPU\">discussion</a>\n   */\n  Puppet.prototype.fixShadowRootClicks = function () {\n    var clickHandler = function (event) {\n      if (lastPuppet) {\n        lastPuppet.clickHandler(event);\n      }\n    };\n\n    //existing shadow roots\n    var shadowRoots = this.findShadowRoots(document.documentElement);\n    for (var i = 0, ilen = shadowRoots.length; i < ilen; i++) {\n      (shadowRoots[i].impl || shadowRoots[i]).addEventListener(\"click\", clickHandler);\n    }\n\n    //future shadow roots\n    var old = Element.prototype.createShadowRoot;\n    Element.prototype.createShadowRoot = function () {\n      var shadowRoot = old.apply(this, arguments);\n      shadowRoot.addEventListener(\"click\", clickHandler);\n      return shadowRoot;\n    }\n  };\n\n  /**\n   * Returns information if a given element is an internal application link that PuppetJS should intercept into a history push\n   * @param elem HTMLElement or String\n   * @returns {boolean}\n   */\n  Puppet.isApplicationLink = function (elem) {\n    if (typeof elem === 'string') {\n      //type string is reported in Polymer / Canary (Web Platform features disabled)\n      var parser = document.createElement('A');\n      parser.href = elem;\n\n      // @see http://stackoverflow.com/questions/736513/how-do-i-parse-a-url-into-hostname-and-path-in-javascript\n      // IE doesn't populate all link properties when setting .href with a relative URL,\n      // however .href will return an absolute URL which then can be used on itself\n      // to populate these additional fields.\n      if (parser.host == \"\") {\n        parser.href = parser.href;\n      }\n\n      elem = parser;\n    }\n    return (elem.protocol == window.location.protocol && elem.host == window.location.host);\n  };\n\n  /**\n   * Cookie helper\n   * @see Puppet.prototype.handleResponseCookie\n   * reference: http://www.quirksmode.org/js/cookies.html\n   * reference: https://github.com/js-coder/cookie.js/blob/gh-pages/cookie.js\n   */\n  var cookie = {\n    create: function createCookie(name, value, days) {\n      var expires = \"\";\n      if (days) {\n        var date = new Date();\n        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));\n        expires = \"; expires=\" + date.toGMTString();\n      }\n      document.cookie = name + \"=\" + value + expires + '; path=/';\n    },\n\n    readAll: function readCookies() {\n      if (document.cookie === '') return {};\n      var cookies = document.cookie.split('; ')\n        , result = {};\n      for (var i = 0, l = cookies.length; i < l; i++) {\n        var item = cookies[i].split('=');\n        result[decodeURIComponent(item[0])] = decodeURIComponent(item[1]);\n      }\n      return result;\n    },\n\n    read: function readCookie(name) {\n      return cookie.readAll()[name];\n    },\n\n    erase: function eraseCookie(name) {\n      cookie.create(name, \"\", -1);\n    }\n  };\n\n  //goes up the DOM tree (including given element) until it finds an element that matches the nodeName\n  var closestHrefParent = function (elem) {\n    while (elem != null) {\n      if (elem.nodeType === 1 && (elem.href || elem.getAttribute('href'))) {\n        return elem;\n      }\n      elem = elem.parentNode;\n    }\n    return null;\n  };\n\n  global.Puppet = Puppet;\n})(window);\n"]}