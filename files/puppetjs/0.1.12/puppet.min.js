/*! puppet.js 0.1.12
 * (c) 2013 Joachim Wester
 * MIT license
 */
!function(a){function b(a,b,c){this.debug=!0,this.remoteUrl=a,this.callback=b,this.obj=c||{},this.observer=null,this.referer=null,this.queue=[],this.handleResponseCookie(),this.ignoreCache=[],this.ignoreAdd=null,this.xhr(this.remoteUrl,"application/json",null,this.bootstrap.bind(this));var d=window.history.pushState,e=this;window.history.pushState=function(a,b,c){d.call(window.history,a,b,c),e.changeState(c)}}function c(a,b){var c=b.split("/"),d=c.length;if(c.length>2)for(var f=1;d-1>f;f++)a=a[c[f]];e(a,c[d-1])}function d(a,b){var c=a[b];null===c?a[b]=j:"object"!=typeof c||c.hasOwnProperty("$parent")||Object.defineProperty(c,"$parent",{enumerable:!1,get:function(){return a}})}function e(a,b){d(a,b),a=a[b];for(var c in a)a.hasOwnProperty(c)&&"object"==typeof a[c]&&e(a,c)}function f(a,b){for(var c in b)b.hasOwnProperty(c)&&("object"==typeof b[c]&&a.hasOwnProperty(c)?f(a[c],b[c]):a[c]=b[c])}var g,h,i,j="␀";b.prototype.bootstrap=function(a){var b=JSON.parse(a.target.responseText);f(this.obj,b),e(this,"obj"),this.observe(),this.callback&&this.callback(this.obj),g&&(document.body.removeEventListener("click",g),window.removeEventListener("popstate",h),document.body.removeEventListener("blur",i,!0)),document.body.addEventListener("click",g=this.clickHandler.bind(this)),window.addEventListener("popstate",h=this.historyHandler.bind(this)),document.body.addEventListener("blur",i=this.sendLocalChange.bind(this),!0),this.fixShadowRootClicks()},b.prototype.handleResponseHeader=function(a){var b=a.getResponseHeader("X-Location")||a.getResponseHeader("Location");b&&this.setReferer(b)},b.prototype.handleResponseCookie=function(){var a=k.read("Location");a&&(this.setReferer(a),k.erase("Location"))},b.prototype.setReferer=function(a){this.referer&&this.referer!==a&&this.showError("Error: Session lost","Server replied with a different session ID that was already set. \nPossibly a server restart happened while you were working. \nPlease reload the page.\n\nPrevious session ID: "+this.referer+"\nNew session ID: "+a),this.referer=a},b.prototype.observe=function(){this.observer=jsonpatch.observe(this.obj,this.queueLocalChange.bind(this))},b.prototype.unobserve=function(){this.observer&&(jsonpatch.unobserve(this.obj,this.observer),this.observer=null)},b.prototype.queueLocalChange=function(a){Array.prototype.push.apply(this.queue,a),("INPUT"!==document.activeElement.nodeName&&"TEXTAREA"!==document.activeElement.nodeName||"input"===document.activeElement.getAttribute("update-on"))&&(this.flattenPatches(this.queue),this.queue.length&&(this.handleLocalChange(this.queue),this.queue.length=0))},b.prototype.sendLocalChange=function(){jsonpatch.generate(this.observer),this.flattenPatches(this.queue),this.queue.length&&(this.handleLocalChange(this.queue),this.queue.length=0)},b.prototype.isIgnored=function(a,b){if(this.ignoreAdd){if("add"===b&&this.ignoreAdd.test(a))return this.ignoreCache[a]=!0,!0;for(var c=a.split("/"),d="",e=1,f=c.length;f>e;e++)if(d+="/"+c[e],this.ignoreCache[d])return!0}return!1},b.prototype.flattenPatches=function(a){for(var b={},c=a.length-1;c>=0;c--)this.isIgnored(a[c].path,a[c].op)?a.splice(c,1):"replace"===a[c].op&&(b[a[c].path]?a.splice(c,1):b[a[c].path]=!0)},b.prototype.handleLocalChange=function(a){var b=JSON.stringify(a);if(b.indexOf("__Jasmine_been_here_before__")>-1)throw new Error("PuppetJs did not handle Jasmine test case correctly");this.xhr(this.referer||this.remoteUrl,"application/json-patch+json",b,this.handleRemoteChange.bind(this));var d=this;this.unobserve(),a.forEach(function(a){"add"!==a.op&&"replace"!==a.op&&"test"!==a.op||null!==a.value||(a.value=j,jsonpatch.apply(d.obj,[a])),c(d.obj,a.path)}),this.observe()},b.prototype.handleRemoteChange=function(a){if(this.observer){var b=JSON.parse(a.target.responseText||"[]");if(void 0===b.length)throw new Error("Patches should be an array");this.unobserve(),jsonpatch.apply(this.obj,b);var d=this;b.forEach(function(b){if("/"===b.path){var e=a.target.responseText;e.length>103&&(e=e.substring(0,100)+"..."),d.showWarning("Server pushed patch that replaces the object root",e)}("add"===b.op||"replace"===b.op||"test"===b.op)&&c(d.obj,b.path)}),this.observe(),this.onRemoteChange&&this.onRemoteChange(b)}},b.prototype.changeState=function(a){this.xhr(a,"application/json-patch+json",null,this.handleRemoteChange.bind(this))},b.prototype.clickHandler=function(a){a.detail&&a.detail.target&&(a=a.detail);var c=a.target;if(c.impl&&(c=c.impl),"A"!==c.nodeName){var d=l(c,"A");d&&(c=d)}var e=c.href||c.getAttribute("href");e&&b.isApplicationLink(e)?(a.preventDefault(),a.stopPropagation(),this.morphUrl(e)):"submit"===c.type?a.preventDefault():this.sendLocalChange()},b.prototype.historyHandler=function(){this.changeState(location.href)},b.prototype.showWarning=function(b,c){this.debug&&a.console&&console.warn&&(c&&(b+=" ("+c+")"),console.warn("PuppetJs warning: "+b))},b.prototype.showError=function(a,b){if(this.debug){var c=document.getElementById("puppetjs-error");c||(c=document.createElement("DIV"),c.id="puppetjs-error",c.style.border="1px solid #dFb5b4",c.style.background="#fcf2f2",c.style.padding="10px 16px",c.style.position="absolute",c.style.top="0",c.style.left="0",c.style.zIndex="999",document.body.appendChild(c));var d=document.createElement("H1");d.innerHTML=a;var e=document.createElement("PRE");e.innerHTML=b,e.style.whiteSpace="pre-wrap",c.appendChild(d),c.appendChild(e)}throw new Error(b)},b.prototype.xhr=function(a,b,c,d,e){k.erase("Location");var f=new XMLHttpRequest,g=this;f.addEventListener("load",function(a){g.handleResponseCookie(),g.handleResponseHeader(a.target),a.target.status>=400&&a.target.status<=599?g.showError("PuppetJs JSON response error","Server responded with error "+a.target.status+" "+a.target.statusText+"\n\n"+a.target.responseText):d.call(g,a)},!1),a=a||window.location.href,c?(f.open("PATCH",a,!0),f.setRequestHeader("Content-Type","application/json-patch+json")):f.open("GET",a,!0),b&&f.setRequestHeader("Accept",b),this.referer&&f.setRequestHeader("X-Referer",this.referer),e&&e.call(g,f),f.send(c)},b.prototype.morphUrl=function(a){history.pushState(null,null,a)},b.prototype.findShadowRoots=function(a,b){b||(b=[]);for(var c=0,d=a.childNodes.length;d>c;c++)1===a.childNodes[c].nodeType&&(a.childNodes[c].shadowRoot&&(b.push(a.childNodes[c].shadowRoot),this.findShadowRoots(a.childNodes[c].shadowRoot,b)),this.findShadowRoots(a.childNodes[c],b));return b},b.prototype.fixShadowRootClicks=function(){for(var a=this.findShadowRoots(document.documentElement),b=0,c=a.length;c>b;b++)(a[b].impl||a[b]).addEventListener("click",this.clickHandler.bind(this));var d=Element.prototype.createShadowRoot,e=this;Element.prototype.createShadowRoot=function(){var a=d.apply(this,arguments);return a.addEventListener("click",e.clickHandler.bind(e)),a}},b.isApplicationLink=function(a){if("string"==typeof a){var b=document.createElement("A");b.href=a,a=b}return a.protocol==window.location.protocol&&a.host==window.location.host};var k={create:function(a,b,c){var d="";if(c){var e=new Date;e.setTime(e.getTime()+24*c*60*60*1e3),d="; expires="+e.toGMTString()}document.cookie=a+"="+b+d+"; path=/"},readAll:function(){if(""===document.cookie)return{};for(var a=document.cookie.split("; "),b={},c=0,d=a.length;d>c;c++){var e=a[c].split("=");b[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return b},read:function(a){return k.readAll()[a]},erase:function(a){k.create(a,"",-1)}},l=function(a,b){for(;null!=a;){if(1===a.nodeType&&b==a.nodeName)return a;a=a.parentNode}return null};a.Puppet=b}(window);
//# sourceMappingURL=puppet.min.js.map