{"version":3,"file":"puppet.min.js","sources":["src/puppet.js"],"names":["global","Puppet","remoteUrl","callback","obj","this","debug","observer","referer","queue","handleResponseCookie","ignoreCache","ignoreAdd","xhr","bootstrap","bind","history_pushState","window","history","pushState","that","data","title","url","call","changeState","markObjPropertyByPath","path","keys","split","len","length","i","recursiveMarkObjProperties","placeMarkers","parent","key","subject","PuppetJsClickTrigger$","hasOwnProperty","Object","defineProperty","enumerable","get","recursiveExtend","par","lastClickHandler","lastPopstateHandler","lastBlurHandler","prototype","event","tmp","JSON","parse","target","responseText","observe","document","body","removeEventListener","addEventListener","clickHandler","historyHandler","sendLocalChange","fixShadowRootClicks","handleResponseHeader","location","getResponseHeader","setReferer","cookie","read","erase","showError","jsonpatch","queueLocalChange","unobserve","patches","Array","push","apply","activeElement","nodeName","getAttribute","flattenPatches","handleLocalChange","generate","isIgnored","op","test","arr","joined","ilen","seen","splice","txt","stringify","indexOf","Error","handleRemoteChange","forEach","patch","value","desc","substring","showWarning","onRemoteChange","href","detail","impl","parentA","closestParent","isApplicationLink","preventDefault","stopPropagation","morphUrl","type","heading","description","console","warn","DIV","getElementById","createElement","id","style","border","background","padding","position","top","left","zIndex","appendChild","H1","innerHTML","PRE","whiteSpace","accept","beforeSend","req","XMLHttpRequest","status","statusText","open","setRequestHeader","send","findShadowRoots","el","out","childNodes","nodeType","shadowRoot","shadowRoots","documentElement","old","Element","createShadowRoot","arguments","elem","parser","protocol","host","create","name","days","expires","date","Date","setTime","getTime","toGMTString","readAll","cookies","result","l","item","decodeURIComponent","parentNode"],"mappings":"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","sourcesContent":["/*! puppet.js 0.1.12\n * (c) 2013 Joachim Wester\n * MIT license\n */\n\n(function (global) {\n  var lastClickHandler\n    , lastPopstateHandler\n    , lastBlurHandler;\n\n  /**\n   * Defines a connection to a remote PATCH server, returns callback to a object that is persistent between browser and server\n   * @param remoteUrl If undefined, current window.location.href will be used as the PATCH server URL\n   * @param callback Called after initial state object is received from the server\n   * @param obj Optional object where the parsed JSON data will be inserted\n   */\n  function Puppet(remoteUrl, callback, obj) {\n    this.debug = true;\n    this.remoteUrl = remoteUrl;\n    this.callback = callback;\n    this.obj = obj || {};\n    this.observer = null;\n    this.referer = null;\n    this.queue = [];\n    this.handleResponseCookie();\n\n    this.ignoreCache = [];\n    this.ignoreAdd = null; //undefined, null or regexp (tested against JSON Pointer in JSON Patch)\n\n    //usage:\n    //puppet.ignoreAdd = null;  //undefined or null means that all properties added on client will be sent to server\n    //puppet.ignoreAdd = /./; //ignore all the \"add\" operations\n    //puppet.ignoreAdd = /\\/\\$.+/; //ignore the \"add\" operations of properties that start with $\n    //puppet.ignoreAdd = /\\/_.+/; //ignore the \"add\" operations of properties that start with _\n\n    this.xhr(this.remoteUrl, 'application/json', null, this.bootstrap.bind(this));\n\n    /**\n     * There is on \"onpushstate\" event, so PuppetJS needs to wrap history.pushState to know when it is called\n     * @type {Function}\n     * @private\n     */\n    var history_pushState = window.history.pushState;\n    var that = this;\n    window.history.pushState = function (data, title, url) {\n      history_pushState.call(window.history, data, title, url);\n      that.changeState(url);\n    };\n  }\n\n  /**\n   * PuppetJsClickTrigger$ contains Unicode symbols for \"NULL\" text rendered stylized using Unicode\n   * character \"SYMBOL FOR NULL\" (2400)\n   *\n   * With PuppetJs, any property having `null` value will be rendered as stylized \"NULL\" text\n   * to emphasize that it probably should be set as empty string instead.\n   *\n   * The benefit of having this string is that any local change to `null` value (also\n   * from `null` to `null`) can be detected and sent as `null` to the server.\n   */\n  var PuppetJsClickTrigger$ = \"\\u2400\";\n\n  function markObjPropertyByPath(obj, path) {\n    var keys = path.split('/');\n    var len = keys.length;\n    if (keys.length > 2) {\n      for (var i = 1; i < len - 1; i++) {\n        obj = obj[keys[i]];\n      }\n    }\n    recursiveMarkObjProperties(obj, keys[len - 1]);\n  }\n\n  function placeMarkers(parent, key) {\n    var subject = parent[key];\n    if (subject === null) {\n      parent[key] = PuppetJsClickTrigger$;\n    }\n    else if (typeof subject === 'object' && !subject.hasOwnProperty('$parent')) {\n      Object.defineProperty(subject, '$parent', {\n        enumerable: false,\n        get: function () {\n          return parent;\n        }\n      });\n    }\n  }\n\n  function recursiveMarkObjProperties(parent, key) {\n    placeMarkers(parent, key);\n    parent = parent[key];\n    for (var i in parent) {\n      if (parent.hasOwnProperty(i) && typeof parent[i] === 'object') {\n        recursiveMarkObjProperties(parent, i);\n      }\n    }\n  }\n\n  function recursiveExtend(par, obj) {\n    for (var i in obj) {\n      if (obj.hasOwnProperty(i)) {\n        if (typeof obj[i] === 'object' && par.hasOwnProperty(i)) {\n          recursiveExtend(par[i], obj[i]);\n        }\n        else {\n          par[i] = obj[i];\n        }\n      }\n    }\n  }\n\n  Puppet.prototype.bootstrap = function (event) {\n    var tmp = JSON.parse(event.target.responseText);\n    recursiveExtend(this.obj, tmp);\n\n    recursiveMarkObjProperties(this, \"obj\");\n    this.observe();\n    if (this.callback) {\n      this.callback(this.obj);\n    }\n    if (lastClickHandler) {\n      document.body.removeEventListener('click', lastClickHandler);\n      window.removeEventListener('popstate', lastPopstateHandler);\n      document.body.removeEventListener('blur', lastBlurHandler, true);\n    }\n    document.body.addEventListener('click', lastClickHandler = this.clickHandler.bind(this));\n    window.addEventListener('popstate', lastPopstateHandler = this.historyHandler.bind(this)); //better here than in constructor, because Chrome triggers popstate on page load\n    document.body.addEventListener('blur', lastBlurHandler = this.sendLocalChange.bind(this), true);\n    this.fixShadowRootClicks();\n  };\n\n  Puppet.prototype.handleResponseHeader = function (xhr) {\n    var location = xhr.getResponseHeader('X-Location') || xhr.getResponseHeader('Location');\n    if (location) {\n      this.setReferer(location);\n    }\n  };\n\n  /**\n   * PuppetJs does not use cookies because of sessions (you need to take care of it in your application code)\n   * Reason PuppetJs handles cookies is different:\n   * JavaScript cannot read HTTP \"Location\" header for the main HTML document, but it can read cookies\n   * So if you want to establish session in the main HTML document, send \"Location\" value as a cookie\n   * The cookie will be erased (replaced with empty value) after reading\n   */\n  Puppet.prototype.handleResponseCookie = function () {\n    var location = cookie.read('Location');\n    if (location) { //if cookie exists and is not empty\n      this.setReferer(location);\n      cookie.erase('Location');\n    }\n  };\n\n  Puppet.prototype.setReferer = function (referer) {\n    if(this.referer && this.referer !== referer) {\n      this.showError(\"Error: Session lost\", \"Server replied with a different session ID that was already set. \\nPossibly a server restart happened while you were working. \\nPlease reload the page.\\n\\nPrevious session ID: \" + this.referer + \"\\nNew session ID: \" + referer);\n    }\n    this.referer = referer;\n  };\n\n  Puppet.prototype.observe = function () {\n    this.observer = jsonpatch.observe(this.obj, this.queueLocalChange.bind(this));\n  };\n\n  Puppet.prototype.unobserve = function () {\n    if (this.observer) { //there is a bug in JSON-Patch when trying to unobserve something that is already unobserved\n      jsonpatch.unobserve(this.obj, this.observer);\n      this.observer = null;\n    }\n  };\n\n  Puppet.prototype.queueLocalChange = function (patches) {\n    Array.prototype.push.apply(this.queue, patches);\n    if ((document.activeElement.nodeName !== 'INPUT' && document.activeElement.nodeName !== 'TEXTAREA') || document.activeElement.getAttribute('update-on') === 'input') {\n      this.flattenPatches(this.queue);\n      if (this.queue.length) {\n        this.handleLocalChange(this.queue);\n        this.queue.length = 0;\n      }\n    }\n  };\n\n  Puppet.prototype.sendLocalChange = function () {\n    jsonpatch.generate(this.observer);\n    this.flattenPatches(this.queue);\n    if (this.queue.length) {\n      this.handleLocalChange(this.queue);\n      this.queue.length = 0;\n    }\n  };\n\n  Puppet.prototype.isIgnored = function (path, op) {\n    if (this.ignoreAdd) {\n      if (op === 'add' && this.ignoreAdd.test(path)) {\n        this.ignoreCache[path] = true;\n        return true;\n      }\n      var arr = path.split('/');\n      var joined = '';\n      for (var i = 1, ilen = arr.length; i < ilen; i++) {\n        joined += '/' + arr[i];\n        if (this.ignoreCache[joined]) {\n          return true; //once we decided to ignore something that was added, other operations (replace, remove, ...) are ignored as well\n        }\n      }\n    }\n    return false;\n  };\n\n  //merges redundant patches and ignores private member changes\n  Puppet.prototype.flattenPatches = function (patches) {\n    var seen = {};\n    for (var i = patches.length - 1; i >= 0; i--) {\n      if (this.isIgnored(patches[i].path, patches[i].op)) {\n        patches.splice(i, 1); //ignore changes to properties that start with PRIVATE_PREFIX\n      }\n      else if (patches[i].op === 'replace') {\n        if (seen[patches[i].path]) {\n          patches.splice(i, 1);\n        }\n        else {\n          seen[patches[i].path] = true;\n        }\n      }\n    }\n  };\n\n  Puppet.prototype.handleLocalChange = function (patches) {\n    var txt = JSON.stringify(patches);\n    if (txt.indexOf('__Jasmine_been_here_before__') > -1) {\n      throw new Error(\"PuppetJs did not handle Jasmine test case correctly\");\n    }\n    //\"referer\" should be used as the url when sending JSON Patches (see https://github.com/PuppetJs/PuppetJs/wiki/Server-communication)\n    this.xhr(this.referer || this.remoteUrl, 'application/json-patch+json', txt, this.handleRemoteChange.bind(this));\n    var that = this;\n    this.unobserve();\n    patches.forEach(function (patch) {\n      if ((patch.op === \"add\" || patch.op === \"replace\" || patch.op === \"test\") && patch.value === null) {\n        patch.value = PuppetJsClickTrigger$;\n        jsonpatch.apply(that.obj, [patch]);\n      }\n      markObjPropertyByPath(that.obj, patch.path);\n    });\n    this.observe();\n  };\n\n  Puppet.prototype.handleRemoteChange = function (event) {\n    if (!this.observer) {\n      return; //ignore remote change if we are not watching anymore\n    }\n    var patches = JSON.parse(event.target.responseText || '[]'); //fault tolerance - empty response string should be treated as empty patch array\n    if (patches.length === void 0) {\n      throw new Error(\"Patches should be an array\");\n    }\n    this.unobserve();\n    jsonpatch.apply(this.obj, patches);\n    var that = this;\n    patches.forEach(function (patch) {\n      if (patch.path === \"/\") {\n        var desc = event.target.responseText;\n        if (desc.length > 103) {\n          desc = desc.substring(0, 100) + \"...\";\n        }\n        that.showWarning(\"Server pushed patch that replaces the object root\", desc);\n      }\n      if (patch.op === \"add\" || patch.op === \"replace\" || patch.op === \"test\") {\n        markObjPropertyByPath(that.obj, patch.path);\n      }\n    });\n    this.observe();\n    if (this.onRemoteChange) {\n      this.onRemoteChange(patches);\n    }\n  };\n\n  Puppet.prototype.changeState = function (href) {\n    this.xhr(href, 'application/json-patch+json', null, this.handleRemoteChange.bind(this));\n  };\n\n  Puppet.prototype.clickHandler = function (event) {\n    if (event.detail && event.detail.target) {\n      //detail is Polymer\n      event = event.detail;\n    }\n    var target = event.target;\n    if (target.impl) {\n      //impl is Polymer\n      target = target.impl;\n    }\n\n    if(target.nodeName !== 'A') {\n      var parentA = closestParent(target, 'A');\n      if(parentA) {\n        target = parentA;\n      }\n    }\n\n    //needed since Polymer 0.2.0 in Chrome stable / Web Plaftorm features disabled\n    //because target.href returns undefined for <polymer-ui-menu-item href=\"...\"> (which is an error)\n    //while target.getAttribute(\"href\") returns desired href (as string)\n    var href = target.href || target.getAttribute(\"href\");\n\n    if (href && Puppet.isApplicationLink(href)) {\n      event.preventDefault();\n      event.stopPropagation();\n      this.morphUrl(href);\n    }\n    else if (target.type === 'submit') {\n      event.preventDefault();\n    }\n    else {\n      this.sendLocalChange(); //needed for checkbox\n    }\n  };\n\n  Puppet.prototype.historyHandler = function (/*event*/) {\n    this.changeState(location.href);\n  };\n\n  Puppet.prototype.showWarning = function (heading, description) {\n    if (this.debug && global.console && console.warn) {\n      if (description) {\n        heading += \" (\" + description + \")\";\n      }\n      console.warn(\"PuppetJs warning: \" + heading);\n    }\n  };\n\n  Puppet.prototype.showError = function (heading, description) {\n    if (this.debug) {\n      var DIV = document.getElementById('puppetjs-error');\n      if (!DIV) {\n        DIV = document.createElement('DIV');\n        DIV.id = 'puppetjs-error';\n        DIV.style.border = '1px solid #dFb5b4';\n        DIV.style.background = '#fcf2f2';\n        DIV.style.padding = '10px 16px';\n        DIV.style.position = 'absolute';\n        DIV.style.top = '0';\n        DIV.style.left = '0';\n        DIV.style.zIndex = '999';\n        document.body.appendChild(DIV);\n      }\n\n      var H1 = document.createElement('H1');\n      H1.innerHTML = heading;\n\n      var PRE = document.createElement('PRE');\n      PRE.innerHTML = description;\n      PRE.style.whiteSpace = 'pre-wrap';\n\n      DIV.appendChild(H1);\n      DIV.appendChild(PRE);\n    }\n    throw new Error(description);\n  };\n\n  /**\n   * Internal method to perform XMLHttpRequest\n   * @param url (Optional) URL to send the request. If empty string, undefined or null given - the request will be sent to window location\n   * @param accept (Optional) HTTP accept header\n   * @param data (Optional) Data payload\n   * @param callback (Optional) function\n   * @param beforeSend (Optional) Function that modifies the XHR object before the request is sent. Added for hackability\n   */\n  Puppet.prototype.xhr = function (url, accept, data, callback, beforeSend) {\n    //this.handleResponseCookie();\n    cookie.erase('Location'); //more invasive cookie erasing because sometimes the cookie was still visible in the requests\n\n    var req = new XMLHttpRequest();\n    var that = this;\n    req.addEventListener('load', function (event) {\n      that.handleResponseCookie();\n      that.handleResponseHeader(event.target);\n      if (event.target.status >= 400 && event.target.status <= 599) {\n        that.showError('PuppetJs JSON response error', 'Server responded with error ' + event.target.status + ' ' + event.target.statusText + '\\n\\n' + event.target.responseText);\n      }\n      else {\n        callback.call(that, event);\n      }\n    }, false);\n    url = url || window.location.href;\n    if (data) {\n      req.open(\"PATCH\", url, true);\n      req.setRequestHeader('Content-Type', 'application/json-patch+json');\n    }\n    else {\n      req.open(\"GET\", url, true);\n    }\n    if (accept) {\n      req.setRequestHeader('Accept', accept);\n    }\n    if (this.referer) {\n      req.setRequestHeader('X-Referer', this.referer);\n    }\n    if (beforeSend) {\n      beforeSend.call(that, req);\n    }\n    req.send(data);\n  };\n\n  /**\n   * Push a new URL to the browser address bar and send a patch request (empty or including queued local patches)\n   * so that the URL handlers can be executed on the server\n   * @param url\n   */\n  Puppet.prototype.morphUrl = function (url) {\n    history.pushState(null, null, url);\n  };\n\n  /**\n   * Returns array of shadow roots inside of a element (recursive)\n   * @param el\n   * @param out (Optional)\n   */\n  Puppet.prototype.findShadowRoots = function (el, out) {\n    if (!out) {\n      out = [];\n    }\n    for (var i = 0, ilen = el.childNodes.length; i < ilen; i++) {\n      if (el.childNodes[i].nodeType === 1) {\n        if (el.childNodes[i].shadowRoot) {\n          out.push(el.childNodes[i].shadowRoot);\n          this.findShadowRoots(el.childNodes[i].shadowRoot, out);\n        }\n        this.findShadowRoots(el.childNodes[i], out);\n      }\n    }\n    return out;\n  };\n\n  /**\n   * Catches clicks in Shadow DOM\n   * @see <a href=\"https://groups.google.com/forum/#!topic/polymer-dev/fDRlCT7nNPU\">discussion</a>\n   */\n  Puppet.prototype.fixShadowRootClicks = function () {\n    //existing shadow roots\n    var shadowRoots = this.findShadowRoots(document.documentElement);\n    for (var i = 0, ilen = shadowRoots.length; i < ilen; i++) {\n      (shadowRoots[i].impl || shadowRoots[i]).addEventListener(\"click\", this.clickHandler.bind(this));\n    }\n\n    //future shadow roots\n    var old = Element.prototype.createShadowRoot;\n    var that = this;\n    Element.prototype.createShadowRoot = function () {\n      var shadowRoot = old.apply(this, arguments);\n      shadowRoot.addEventListener(\"click\", that.clickHandler.bind(that));\n      return shadowRoot;\n    }\n  };\n\n  /**\n   * Returns information if a given element is an internal application link that PuppetJS should intercept into a history push\n   * @param elem HTMLElement or String\n   * @returns {boolean}\n   */\n  Puppet.isApplicationLink = function (elem) {\n    if (typeof elem === 'string') {\n      //type string is reported in Polymer / Canary (Web Platform features disabled)\n      var parser = document.createElement('A');\n      parser.href = elem;\n      elem = parser;\n    }\n    return (elem.protocol == window.location.protocol && elem.host == window.location.host);\n  };\n\n  /**\n   * Cookie helper\n   * @see Puppet.prototype.handleResponseCookie\n   * reference: http://www.quirksmode.org/js/cookies.html\n   * reference: https://github.com/js-coder/cookie.js/blob/gh-pages/cookie.js\n   */\n  var cookie = {\n    create: function createCookie(name, value, days) {\n      var expires = \"\";\n      if (days) {\n        var date = new Date();\n        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));\n        expires = \"; expires=\" + date.toGMTString();\n      }\n      document.cookie = name + \"=\" + value + expires + '; path=/';\n    },\n\n    readAll: function readCookies() {\n      if (document.cookie === '') return {};\n      var cookies = document.cookie.split('; ')\n        , result = {};\n      for (var i = 0, l = cookies.length; i < l; i++) {\n        var item = cookies[i].split('=');\n        result[decodeURIComponent(item[0])] = decodeURIComponent(item[1]);\n      }\n      return result;\n    },\n\n    read: function readCookie(name) {\n      return cookie.readAll()[name];\n    },\n\n    erase: function eraseCookie(name) {\n      cookie.create(name, \"\", -1);\n    }\n  };\n\n  //goes up the DOM tree (including given element) until it finds an element that matches the nodeName\n  var closestParent = function (elem, nodeName) {\n    while (elem != null) {\n      if (elem.nodeType === 1 && nodeName == elem.nodeName) {\n        return elem;\n      }\n      elem = elem.parentNode;\n    }\n    return null;\n  };\n\n  global.Puppet = Puppet;\n})(window);"]}