/* Postcodify, LGPL v3, see https://github.com/kijin/postcodify */
(function($){if(typeof $.fn.postcodify!=="undefined")return;var info={version:"1.8"};$.fn.postcodify=function(options){return this.each(function(){var settings=$.extend({api:info.freeAPI.defaultUrl,apiBackup:null,callBackupFirst:false,controls:this,results:this,language:"ko",searchButtonContent:null,mapLinkProvider:false,mapLinkContent:null,insertDbid:null,insertPostcode5:null,insertPostcode6:null,insertAddress:null,insertJibeonAddress:null,insertEnglishAddress:null,insertEnglishJibeonAddress:null,insertDetails:null,insertExtraInfo:null,timeout:2400,timeoutBackup:7200,beforeSearch:function(keywords){},afterSearch:function(keywords,results){},beforeSelect:function(selectedEntry){},afterSelect:function(selectedEntry){},onReady:function(){},onSuccess:function(){},onBackup:function(){},onError:function(){},onComplete:function(){},focusKeyword:true,focusDetails:true,hideOldAddresses:true,useFullJibeon:false},options);settings.language=settings.language.toLowerCase();if(settings.api===info.freeAPI.defaultUrl&&settings.apiBackup===null){settings.apiBackup=info.freeAPI.backupUrl}if(settings.searchButtonContent===null){settings.searchButtonContent=info.translations[settings.language].msgSearch}var results=$(settings.results);var controls=$('<div class="postcode_search_controls"></div>');var keywordInput=$('<input type="text" class="keyword" value="" />').appendTo(controls);var searchButton=$('<button type="button" class="search_button"></button>').html(settings.searchButtonContent).appendTo(controls);controls.prependTo(settings.controls);var previousSearch="";keywordInput.blur(function(event){searchButton.trigger("click")});keywordInput.keypress(function(event){if(event.which==13){event.preventDefault();searchButton.trigger("click")}});searchButton.click(function(event){event.preventDefault();var keywords=$.trim(keywordInput.val());if(keywords===previousSearch)return;previousSearch=keywords;results.find("div.postcode_search_result,div.postcode_search_status").remove();if(keywords.length<3){$('<div class="postcode_search_status too_short"></div>').html(info.translations[settings.language].errorTooShort.replace("\n","<br>")).appendTo(results);return}if(settings.beforeSearch(keywords)===false)return;var prevScrollTop=$(window).scrollTop();searchButton.attr("disabled","disabled");var searchButtonAnimation;if(navigator.userAgent&&navigator.userAgent.match(/MSIE [5-8]\./)){searchButton.text(".");searchButtonAnimation=setInterval(function(){switch(searchButton.text()){case".":searchButton.text("..");break;case"..":searchButton.text("...");break;case"...":searchButton.text("....");break;case"....":searchButton.text(".");break}},160)}else{searchButton.html('<img class="searching" alt="'+info.translations[settings.language].msgSearch+'" src="'+info.searchProgress+'" />');searchButtonAnimation=false}var ajaxStartTime;var ajaxSuccess;var ajaxErrorInitial;var ajaxErrorFinal;var ajaxCall=function(url,timeout,errorCallback){ajaxStartTime=(new Date).getTime();settings.currentRequestUrl=url;$.ajax({url:url,data:{v:info.version,q:keywords,ref:window.location.hostname},dataType:"jsonp",jsonpCallback:"postcodify"+ajaxStartTime,processData:true,cache:false,timeout:settings.timeout,success:ajaxSuccess,error:errorCallback,complete:function(){$(window).scrollTop(prevScrollTop);if(searchButtonAnimation!==false)clearTimeout(searchButtonAnimation);searchButton.removeAttr("disabled").html(settings.searchButtonContent)}})};ajaxSuccess=function(data,textStatus,jqXHR){var searchTotalTime=((new Date).getTime()-ajaxStartTime)/1e3;if(settings.currentRequestUrl===settings.apiBackup){settings.callBackupFirst=true}if(settings.afterSearch(keywords,data.results)===false)return;if(data.error&&data.error.toLowerCase().indexOf("database")>-1){if(settings.currentRequestUrl===settings.api&&settings.apiBackup&&settings.api!==settings.apiBackup){settings.onBackup();ajaxCall(settings.apiBackup,settings.timeoutBackup,ajaxErrorFinal)}}else if(data.error&&data.error.toLowerCase().indexOf("quota")>-1){$('<div class="postcode_search_status quota"></div>').html(info.translations[settings.language].errorQuota.replace("\n","<br>")).appendTo(results)}else if(data.error){$('<div class="postcode_search_status error"></div>').html(info.translations[settings.language].errorError.replace("\n","<br>")).appendTo(results);previousSearch=""}else if(data.count===0){$('<div class="postcode_search_status empty"></div>').html(info.translations[settings.language].errorEmpty.replace("\n","<br>")).appendTo(results)}else if(typeof data.results[0].english==="undefined"||typeof data.results[0].other==="undefined"){$('<div class="postcode_search_status error"></div>').html(info.translations[settings.language].errorVersion.replace("\n","<br>")).appendTo(results)}else{for(var i=0;i<data.count;i++){var result=data.results[i];var option=$('<div class="postcode_search_result"></div>');option.data("dbid",result.dbid);option.data("code6",result.code6);option.data("code5",result.code5);option.data("address",result.address.base+" "+result.address["new"]);option.data("jibeon_address",result.address["base"]+" "+result.address["old"]);option.data("english_address",result.english["new"]+", "+result.english["base"]);option.data("english_jibeon_address",result.english["old"]+", "+result.english["base"]);option.data("extra_info_long",result.other["long"]);option.data("extra_info_short",result.other["short"]);var mainText;var extraText;var resultLanguage;if(typeof data.lang!=="undefined"&&data.lang==="EN"){resultLanguage="en";if(typeof data.sort!=="undefined"&&data.sort==="JUSO"){mainText=result.english["new"]+", "+result.english["base"];extraText=result.english["old"]}else{mainText=result.english["old"]+", "+result.english["base"];extraText=result.english["new"]}}else{resultLanguage="ko";if(typeof data.sort!=="undefined"&&data.sort==="JUSO"){mainText=result.address["base"]+" "+result.address["new"];extraText=result.other["long"]}else{mainText=result.address["base"]+" "+result.address["old"];extraText=result.address["new"]}}var selector=$('<a class="selector" href="#"></a>');selector.append($('<span class="address_info"></span>').text(mainText));if(extraText!==null&&extraText!==""){selector.append($('<span class="extra_info"></span>').append("("+extraText+")"))}$('<div class="code6"></div>').text(result.code6).appendTo(option);$('<div class="code5"></div>').text(result.code5).appendTo(option);$('<div class="address"></div>').append(selector).appendTo(option);if(typeof data.lang!=="undefined"&&data.lang==="EN"){result.other["others"]=result.other["others"].replace(/\uc0b0([0-9]+)/g,"San $1");result.other["others"]=$.trim(result.other["others"].replace(/[^0-9a-zA-Z\x20.,-]/g,"").replace(/\s+/g," "))}if(result.other["others"]!==""){var oldAddrLink=$('<a href="#" class="show_old_addresses">▼</a>').attr("title",info.translations[resultLanguage].msgShowOthers);oldAddrLink.appendTo(option.find("div.address"));var oldAddrDiv=$('<div class="old_addresses"></div>').text(result.other["others"]);if(settings.hideOldAddresses)oldAddrDiv.css("display","none");oldAddrDiv.appendTo(option)}if(settings.mapLinkProvider){var mapurl;if(typeof info.mapProviders[settings.mapLinkProvider]!=="undefined"){mapurl=info.mapProviders[settings.mapLinkProvider]}else{mapurl=settings.mapLinkProvider}mapurl=mapurl.replace("$JUSO",encodeURIComponent(result.address["base"]+" "+result.address["new"]).replace(/%20/g,"+"));mapurl=mapurl.replace("$JIBEON",encodeURIComponent(result.address["base"]+" "+result.address["old"]).replace(/%20/g,"+"));var mapLinkContent=settings.mapLinkContent!==null?settings.mapLinkContent:info.translations[resultLanguage].msgMap;var maplink=$('<a target="_blank"></a>').attr("href",mapurl).html(mapLinkContent);$('<div class="map_link"></div>').append(maplink).appendTo(option)}option.appendTo(results)}var summary=$('<div class="postcode_search_status summary"></div>');summary.append('<div class="result_count">'+info.translations[resultLanguage].msgResultCount+": "+"<span>"+data.count+"</span></div>");summary.append('<div class="search_time">'+info.translations[resultLanguage].msgSearchTime+": "+"<span>"+Math.round(data.time*1e3)+"ms</span></div>");summary.append('<div class="network_time">'+info.translations[resultLanguage].msgNetworkTime+": "+"<span>"+Math.round((searchTotalTime-parseFloat(data.time))*1e3)+"ms</span></div>");summary.appendTo(results);if(data.count>=100){$('<div class="postcode_search_status too_many"></div>').html(info.translations[resultLanguage].errorTooMany.replace("\n","<br>")).prependTo(results)}}settings.onSuccess();settings.onComplete()};ajaxErrorInitial=function(jqXHR,textStatus,errorThrown){if(settings.apiBackup){settings.onBackup();ajaxCall(settings.apiBackup,settings.timeoutBackup,ajaxErrorFinal)}else{ajaxErrorFinal(jqXHR,textStatus,errorThrown)}};ajaxErrorFinal=function(jqXHR,textStatus,errorThrown){results.find("div.postcode_search_status.error").show();previousSearch="";settings.onError();settings.onComplete()};if(settings.apiBackup&&settings.callBackupFirst){ajaxCall(settings.apiBackup,settings.timeoutBackup,ajaxErrorFinal)}else{ajaxCall(settings.api,settings.timeout,ajaxErrorInitial)}});results.on("click","div.code6,div.code5,div.old_addresses",function(event){event.preventDefault();event.stopPropagation();$(this).parent().find("a.selector").click()});results.on("click","a.selector",function(event){event.preventDefault();var entry=$(this).parents("div.postcode_search_result");if(settings.beforeSelect(entry)===false)return;if(settings.insertDbid)$(settings.insertDbid).val(entry.data("dbid"));if(settings.insertPostcode6)$(settings.insertPostcode6).val(entry.data("code6"));if(settings.insertPostcode5)$(settings.insertPostcode5).val(entry.data("code5"));if(settings.insertAddress)$(settings.insertAddress).val(entry.data("address"));if(settings.insertJibeonAddress)$(settings.insertJibeonAddress).val(entry.data("jibeon_address"));if(settings.insertEnglishAddress)$(settings.insertEnglishAddress).val(entry.data("english_address"));if(settings.insertEnglishJibeonAddress)$(settings.insertEnglishJibeonAddress).val(entry.data("english_jibeon_address"));if(settings.insertExtraInfo){var extra_info=settings.useFullJibeon?entry.data("extra_info_long"):entry.data("extra_info_short");if(extra_info.length)extra_info="("+extra_info+")";if(settings.insertExtraInfo===settings.insertAddress){$(settings.insertExtraInfo).val($(settings.insertExtraInfo).val()+"\n"+extra_info)}else{$(settings.insertExtraInfo).val(extra_info)}}if(settings.afterSelect(entry)===false)return;if(settings.insertDetails&&settings.focusDetails){$(settings.insertDetails).focus()}});results.on("click","a.show_old_addresses",function(event){event.preventDefault();var oldAddrDiv=$(this).parent().siblings(".old_addresses");if(oldAddrDiv.is(":visible")){$(this).html("&#9660;");oldAddrDiv.hide()}else{$(this).html("&#9650;");oldAddrDiv.show()}});if(settings.focusKeyword)keywordInput.focus();settings.onReady();return this})};info.freeAPI={defaultUrl:"//api.poesis.kr/post/search.php",backupUrl:"//backup.api.poesis.kr/post/search.php"};info.mapProviders={daum:"http://map.daum.net/?map_type=TYPE_MAP&urlLevel=3&q=$JUSO",naver:"http://map.naver.com/?mapMode=0&dlevel=12&query=$JUSO",google:"http://www.google.com/maps/place/대한민국+$JUSO"};info.translations={ko:{errorError:"검색 서버와 통신 중 오류가 발생하였습니다.\n잠시 후 다시 시도해 주시기 바랍니다.",errorEmpty:"검색 결과가 없습니다. 주소가 정확한지 다시 확인해 주십시오.\n띄어쓰기에 유의하시기 바랍니다.",errorQuota:"일일 허용 쿼리수를 초과하였습니다.\n관리자에게 문의해 주시기 바랍니다.",errorVersion:"검색 서버의 버전이 낮아 이 검색창과 호환되지 않습니다.",errorTooShort:"검색어는 3글자 이상 입력해 주십시오.",errorTooMany:"검색 결과가 너무 많아 100건까지만 표시합니다.\n행정구역명, 번지수 등을 사용하여 좀더 자세히 검색해 주시기 바랍니다.",msgResultCount:"검색 결과",msgSearchTime:"소요 시간",msgNetworkTime:"통신 지연",msgSeeOthers:"관련지번 보기",msgSearch:"검색",msgMap:"지도"},en:{errorError:"An error occurred while communicating to the search server.\nPlease try again later.",errorEmpty:"No addresses matched your search.\nPlease check if your search terms are accurately spelled.",errorQuota:"This website and/or your IP address has exceeded its daily search quota.\nPlease contact the administrator.",errorVersion:"The version of the search server is not compatible with this search function.",errorTooShort:"Please enter at least 3 characters.",errorTooMany:"Your search returned too many results. Only the first 100 items are shown below.\nPlease narrow down your search by adding the street number(s).",msgResultCount:"Results",msgSearchTime:"Time taken",msgNetworkTime:"Network delay",msgSeeOthers:"See related addresses",msgSearch:"Search",msgMap:"Map"}};info.searchProgress="data:image/gif;base64,R0lGODlhEAALAPQAAP///yIiIt7"+"e3tbW1uzs7CcnJyIiIklJSZKSknV1dcPDwz8/P2JiYpmZmXh4eMbGxkJCQiUlJWVlZe"+"np6d3d3fX19VJSUuDg4PPz87+/v6ysrNDQ0PDw8AAAAAAAAAAAACH/C05FVFNDQVBFM"+"i4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCwAAACwAAAAA"+"EAALAAAFLSAgjmRpnqSgCuLKAq5AEIM4zDVw03ve27ifDgfkEYe04kDIDC5zrtYKRa2"+"WQgAh+QQJCwAAACwAAAAAEAALAAAFJGBhGAVgnqhpHIeRvsDawqns0qeN5+y967tYLy"+"icBYE7EYkYAgAh+QQJCwAAACwAAAAAEAALAAAFNiAgjothLOOIJAkiGgxjpGKiKMkbz"+"7SN6zIawJcDwIK9W/HISxGBzdHTuBNOmcJVCyoUlk7CEAAh+QQJCwAAACwAAAAAEAAL"+"AAAFNSAgjqQIRRFUAo3jNGIkSdHqPI8Tz3V55zuaDacDyIQ+YrBH+hWPzJFzOQQaeav"+"Wi7oqnVIhACH5BAkLAAAALAAAAAAQAAsAAAUyICCOZGme1rJY5kRRk7hI0mJSVUXJtF"+"3iOl7tltsBZsNfUegjAY3I5sgFY55KqdX1GgIAIfkECQsAAAAsAAAAABAACwAABTcgI"+"I5kaZ4kcV2EqLJipmnZhWGXaOOitm2aXQ4g7P2Ct2ER4AMul00kj5g0Al8tADY2y6C+"+"4FIIACH5BAkLAAAALAAAAAAQAAsAAAUvICCOZGme5ERRk6iy7qpyHCVStA3gNa/7txx"+"wlwv2isSacYUc+l4tADQGQ1mvpBAAIfkECQsAAAAsAAAAABAACwAABS8gII5kaZ7kRF"+"GTqLLuqnIcJVK0DeA1r/u3HHCXC/aKxJpxhRz6Xi0ANAZDWa+kEAA7AAAAAAAAAAAA"})(jQuery);